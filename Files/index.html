<!DOCTYPE HTML>
<HTML lang="en">
    <HEAD>
        <meta charset='utf-8'>

        <title>Admin menu : login</title>

        <style>
            .notificationMenu {
                position:absolute;
                margin-left:50%;
                left:-25%;
                width:50%;
                min-width:350px;
                height:100%;
                min-height:500px;
                background-color:#bfbfbf;
                font-family: fantasy;

                top:-500px;
                opacity=0.5;
                display:none;

                transition-property: top , opacity;
                transition-duration: 300ms;
            }

            .divider {
                position:relative;
                width:100%;
                height:1px;
                background-color:#888;
                border-color:#aaa;
                border-style:solid;
                border-top-width: 1px;
                border-bottom-width: 1px;
                border-left-width: 0px;
                border-right-width: 0px;
            }

            <?login.css/>

            .imgButton{
                position:absolute;
                border-width:2px;
                border-style:solid;
                border-top-width:3px;
                border-left-width:3px;
                padding: 10px 10px 10px;
                text-align:center;
                color:#000;
                font-size:20px;
                width:133px;
                height:133px;
                top:0px;

                display:block;

                transition-property: background-color , border-color;
                transition-duration: 200ms;
            }

            .imgButtonContent{
                position: absolute;
                width:133px;
                height:133px;
                display:none;
            }

            .imgButtonImg{
                position:relative;
                width:100%;
                height:103px;
                margin-bottom: 10px;
            }

            <?mainMenu.css/>

            <?errorMenu.css/>
        </style>
        <script src="sodium.js" async defer></script>
        <script>
            var cryptoLibIsReady=false;
            window.sodium = { onload: function(sodium) {
                cryptoLibIsReady=true;
            }};

            var sessionKey="";
            var sessionNonce="";

            var answerKey="";
            var answerNonce="";

            var adminKey="";
            var newsTimer="";
            var newsTimerInterval=200;

            if (!String.prototype.format) {
                String.prototype.format = function() {
                    var args = arguments;
                    return this.replace(/{(\d+)}/g, function(match, number) {
                        return typeof args[number] != 'undefined'
                        ? args[number]
                        : match
                        ;
                    });
                };
            }

            function checkNews(){
                var sodium=window.sodium;

                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/arenews', true);
                xhr.send(adminKey);

                xhr.onreadystatechange = function() {
                    if( xhr.readyState != 4 ) return;

                    if( xhr.status==200 ){
                        loadNews(xhr.responseText);
                    }else{
                        console.log( xhr.status + ': ' + xhr.statusText + ':' + xhr.responseText );
                    }
                }
            }

            function loadNews(responseText){
                var cipherBody=new Uint8Array( sodium.from_base64(responseText) );
                body=sodium.crypto_secretbox_open_easy(cipherBody, responseNonce, responseKey, "text");

                var fields=body.split(";\n");

                console.log("news"+fields.length);

                for(i=0;i<fields.length;i++){
                    var field=fields[i];

                    var colonPos=field.indexOf(":");
                    if( colonPos>0 ){
                        var fieldName=field.slice(0, colonPos);
                        var fieldValue=field.slice(colonPos+1);

                        if( fieldName=="admin key" ){
                            adminKey=fieldValue;
                        }else if( fieldName=="log" ){
                            document.getElementById("consoleLog").innerHTML+=fieldValue+"\n";
                        }
                    }
                }

                if( fields.length>2 ){
                    newsTimerInterval=50;
                    clearInterval(newsTimer);
                    newsTimer=setInterval(function() {
                        checkNews();
                    }, newsTimerInterval);
                }else{
                    newsTimerInterval=200;
                    clearInterval(newsTimer);
                    newsTimer=setInterval(function() {
                        checkNews();
                    }, newsTimerInterval);
                }
            }

            <?login.js/>
            <?mainMenu.js/>

            <?errorMenu.js/>
        </script>
    </HEAD>
    <BODY>
        <div style="position:absolute; width:100%; height:100%; background-image:url(background.png); background-repeat:repeat;" >
        <?login.html/>
        <?mainMenu.html/>

        <?errorMenu.html/>
    </div>
    </BODY>
</HTML>
